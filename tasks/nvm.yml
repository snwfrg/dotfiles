---
- name: Check if NVM is installed
  stat:
    path: "{{ home }}/.nvm/nvm.sh"
  register: nvm_stat

- name: Install NVM
  shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/{{ nvm_version }}/install.sh | bash
  args:
    creates: "{{ home }}/.nvm"
  when: not nvm_stat.stat.exists

- name: Check if Node.js is already installed via NVM
  stat:
    path: "{{ home }}/.nvm/versions/node"
  register: node_installed

- name: Source NVM and install Node.js LTS
  shell: |
    export NVM_DIR="{{ home }}/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install --lts
    nvm use --lts
    nvm alias default 'lts/*'
  args:
    executable: /bin/bash
  when: not node_installed.stat.exists